<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Home</title>

    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://api.open-meteo.com" crossorigin />
    <link rel="dns-prefetch" href="//api.open-meteo.com" />
  </head>

  <body>
    <div class="bg"></div>
    <div class="overlay"></div>

    <main class="wrap">
      <header class="top">
        <div class="top-left">
          <h1 class="title">Home</h1>
          <p class="subtitle" id="subtitle"></p>
        </div>

        <div class="top-right">
          <div class="top-actions">
            <a
              class="back-link back-link--small"
              href="https://www.buk1t.com"
              rel="noopener"
            >
              ‚Üê buk1t.com
            </a>
            <a class="iconbtn" href="./settings.html" aria-label="Settings">
              <!-- gear icon -->
              <svg
                class="ico"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M4 6h10"></path>
                <path d="M18 6h2"></path>
                <circle cx="16" cy="6" r="2"></circle>

                <path d="M4 12h2"></path>
                <path d="M10 12h10"></path>
                <circle cx="8" cy="12" r="2"></circle>

                <path d="M4 18h14"></path>
                <path d="M22 18h-2"></path>
                <circle cx="20" cy="18" r="2"></circle>
              </svg>
            </a>
          </div>

          <form class="search" id="searchForm" autocomplete="off">
            <input
              class="search-input"
              id="searchInput"
              type="text"
              inputmode="search"
              placeholder="Search or type a URL"
              aria-label="Search"
            />
          </form>
        </div>
      </header>
      <div class="layout">
        <section class="left">
          <div class="grid" id="linksGrid"></div>
        </section>

        <aside class="right">
          <div class="panel" id="weatherPanel">
            <div class="panel-head">
              <div class="panel-title">Weather</div>
              <div class="pill" id="weatherCity">Seattle</div>
            </div>

            <div class="weather-main">
              <div class="weather-big">
                <span class="weather-emoji" id="wxEmoji">‚õÖÔ∏è</span>
                <span class="weather-temp" id="wxTemp">--¬∞</span>
              </div>

              <div class="weather-sub" id="wxDesc">Loading‚Ä¶</div>
              <div class="weather-mini" id="wxMini"></div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Checklist</div>
            </div>

            <div class="panel-sub">(auto-saves)</div>
            <div class="todo todo-lines" id="todo"></div>
            <div class="modal" id="archiveModal" aria-hidden="true">
              <div class="modal-backdrop" id="archiveClose"></div>

              <div
                class="modal-card"
                role="dialog"
                aria-modal="true"
                aria-label="Archive"
              >
                <div class="modal-head">
                  <div class="modal-title">Archive</div>
                </div>

                <div class="modal-sub">
                  Completed tasks (auto-moved 5s after checking)
                </div>
                <div class="archive-list" id="archiveList"></div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
    <div class="version" id="version"></div>
    <script src="version.js"></script>
    <script src="icons.js"></script>
    <script src="script.js"></script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Settings</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="bg"></div>
    <div class="overlay"></div>

    <main class="wrap">
      <header class="top">
        <div class="top-left">
          <h1 class="title">Settings</h1>
          <p class="subtitle">Customize links, weather, and time.</p>
        </div>

        <div class="top-right">
          <div class="top-actions" style="justify-content: flex-end">
            <a class="back-link" href="./index.html">‚Üê Home</a>
          </div>
        </div>
      </header>

      <div class="layout" style="grid-template-columns: 1fr 330px">
        <section class="left">
          <!-- Weather -->
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Location city</div>
              <div class="pill" id="currentCityPill">Seattle</div>
            </div>
            <div class="panel-sub">Search and select a city.</div>

            <form
              id="cityForm"
              class="search"
              autocomplete="off"
              style="margin-top: 12px"
            >
              <input
                class="search-input"
                id="cityInput"
                type="text"
                placeholder="Search city (e.g., Seattle)"
              />
            </form>

            <div id="cityResults" style="margin-top: 12px"></div>
          </div>

          <!-- Links -->
          <div class="panel" style="margin-top: 14px">
            <div class="panel-head">
              <div class="panel-title">Links grid</div>
              <button class="ghostbtn" id="addLinkBtn" type="button">
                Add link
              </button>
            </div>
            <div class="panel-sub">These appear on your Home grid.</div>

            <div id="linksList" style="margin-top: 12px"></div>
          </div>

          <!-- Add/Edit Modal -->
          <div class="modal" id="linkModal" aria-hidden="true">
            <div class="modal-backdrop" id="linkModalClose"></div>

            <div
              class="modal-card"
              role="dialog"
              aria-modal="true"
              aria-label="Edit link"
            >
              <div class="modal-head">
                <div class="modal-title" id="linkModalTitle">Add link</div>
                <button class="archive-btn" id="linkModalDone" type="button">
                  Done
                </button>
              </div>

              <div style="margin-top: 12px; display: grid; gap: 10px">
                <label
                  style="font-size: 12px; color: var(--muted); font-weight: 600"
                  >Title</label
                >
                <input
                  id="linkTitle"
                  class="search-input"
                  style="padding: 14px 16px; font-size: 16px"
                  placeholder="e.g., YouTube"
                />

                <label
                  style="font-size: 12px; color: var(--muted); font-weight: 600"
                  >URL</label
                >
                <input
                  id="linkUrl"
                  class="search-input"
                  style="padding: 14px 16px; font-size: 16px"
                  placeholder="e.g., https://youtube.com"
                />

                <label
                  style="font-size: 12px; color: var(--muted); font-weight: 600"
                  >Icon</label
                >
                <div
                  id="iconPicker"
                  style="
                    display: grid;
                    grid-template-columns: repeat(6, minmax(0, 1fr));
                    gap: 10px;
                  "
                ></div>

                <div
                  style="
                    display: flex;
                    gap: 10px;
                    justify-content: flex-end;
                    margin-top: 8px;
                  "
                >
                  <button
                    class="ghostbtn"
                    id="deleteLinkBtn"
                    type="button"
                    style="display: none"
                  >
                    Delete
                  </button>
                  <button class="ghostbtn" id="saveLinkBtn" type="button">
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <aside class="right">
          <!-- Archive on settings -->
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Archive</div>
            </div>
            <div class="panel-sub">Completed tasks from Home.</div>

            <div
              class="archive-list"
              id="archiveList"
              style="margin-top: 12px"
            ></div>
          </div>
        </aside>
      </div>
    </main>
    <div class="version" id="version"></div>
    <script src="version.js"></script>
    <script src="icons.js"></script>
    <script src="settings.js"></script>
  </body>
</html>
/* =========================
   Fonts
   ========================= */

@font-face {
  font-family: "Inter";
  src: url("assets/fonts/Inter-roman.ttf") format("truetype");
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}

/* If you actually kept italic, keep this. If not, delete this block. */
@font-face {
  font-family: "Inter";
  src: url("assets/fonts/Inter-italic.ttf") format("truetype");
  font-weight: 100 900;
  font-style: italic;
  font-display: swap;
}

/* =========================
   Theme tokens
   ========================= */

:root {
  /* Typography */
  --font: "Inter", ui-sans-serif, system-ui, -apple-system, "SF Pro Text",
    "Segoe UI", Roboto, Helvetica, Arial;

  /* Text */
  --text: rgba(24, 24, 22, 0.92);
  --muted: rgba(24, 24, 22, 0.6);

  /* Surfaces */
  --card: rgba(246, 242, 234, 0.86);
  --card2: rgba(236, 231, 223, 0.72);

  /* Borders */
  --stroke: rgba(24, 24, 22, 0.14);
  --stroke-strong: rgba(24, 24, 22, 0.26);

  /* Shadow */
  --shadow: 0 18px 46px rgba(0, 0, 0, 0.12);

  /* Radius */
  --radius: 22px;

  /* Background */
  --bg-grad: radial-gradient(
      900px 650px at 20% 12%,
      rgba(255, 255, 255, 0.32),
      rgba(255, 255, 255, 0)
    ),
    linear-gradient(135deg, #d3d6cd 0%, #dee1d9 45%, #d1d4cb 100%);

  /* Overlay glass */
  --overlay-grad: radial-gradient(
    1200px 700px at 25% 15%,
    rgba(255, 255, 255, 0.12),
    rgba(0, 0, 0, 0.08)
  );

  /* Shared component styling */
  --surface: linear-gradient(180deg, var(--card), var(--card2));
  --surface-quiet: color-mix(in srgb, var(--card2) 78%, transparent 22%);

  /* Icon styling (thin + minimal) */
  --icon-size: 20px;
  --icon-stroke: 1.45;
  --icon-bg: color-mix(in srgb, var(--card2) 70%, transparent 30%);
  --icon-border: color-mix(in srgb, var(--stroke) 75%, transparent 25%);
  --icon-fg: color-mix(in srgb, var(--text) 76%, transparent 24%);
}

@media (prefers-color-scheme: dark) {
  :root {
    --text: rgba(245, 246, 250, 0.92);
    --muted: rgba(245, 246, 250, 0.62);

    --card: rgba(16, 17, 22, 0.78);
    --card2: rgba(16, 17, 22, 0.56);

    --stroke: rgba(255, 255, 255, 0.12);
    --stroke-strong: rgba(255, 255, 255, 0.22);

    --shadow: 0 22px 70px rgba(0, 0, 0, 0.42);

    --bg-grad: radial-gradient(
        900px 650px at 20% 10%,
        rgba(92, 160, 255, 0.18),
        rgba(0, 0, 0, 0)
      ),
      linear-gradient(135deg, #040814 0%, #071227 45%, #061a24 100%);

    --overlay-grad: radial-gradient(
      1200px 700px at 25% 15%,
      rgba(90, 200, 250, 0.07),
      rgba(0, 0, 0, 0.52)
    );

    --surface: rgba(16, 17, 22, 0.66);
    --surface-quiet: rgba(255, 255, 255, 0.06);

    --icon-bg: rgba(255, 255, 255, 0.06);
    --icon-border: rgba(255, 255, 255, 0.14);
    --icon-fg: color-mix(in srgb, var(--text) 78%, transparent 22%);
  }
}

/* =========================
   Base
   ========================= */

* {
  box-sizing: border-box;
}

html,
body {
  height: 100%;
}

body {
  margin: 0;
  font-family: var(--font);
  color: var(--text);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* =========================
   Background
   ========================= */

.bg {
  position: fixed;
  inset: 0;
  background: var(--bg-grad);
  transition: background 220ms ease;
  z-index: 0;
}

.overlay {
  position: fixed;
  inset: 0;
  background: var(--overlay-grad);
  backdrop-filter: blur(10px);
  transition: background 220ms ease;
  z-index: 0;
}

/* =========================
   Wrapper + Header
   ========================= */

.wrap {
  position: relative;
  z-index: 1;
  max-width: 1180px;
  margin: 0 auto;
  padding: 28px 18px 48px;
}

.top {
  margin-bottom: 16px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

/* Header stability */
.top-left {
  margin-bottom: 1vw;
}
.top-left,
.top-right {
  min-width: 0;
}

.title {
  margin: 0;
  font-size: 38px;
  font-weight: 760;
  letter-spacing: -0.035em;
}

.subtitle {
  margin-top: 8px;
  margin-bottom: 0px;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
}

/* Header right side (actions + search) */
.top-right {
  display: grid;
  gap: 10px;
}

.top-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* Search */
.search {
  width: 100%;
}

.search-input {
  width: 100%;
  min-width: 0;
  padding: 18px 20px;
  border-radius: 24px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
  font-size: 18px;
  color: var(--text);
  outline: none;
  transition: border-color 180ms ease, box-shadow 180ms ease,
    background 180ms ease;
}

.search-input:focus {
  border-color: var(--stroke-strong);
  box-shadow: 0 16px 44px rgba(0, 0, 0, 0.12);
}

@media (min-width: 720px) {
  .top {
    grid-template-columns: 1fr minmax(420px, 760px);
    align-items: end;
  }
  .search {
    justify-self: stretch;
  }
  .top-right {
    justify-self: stretch;
  }
}

@media (max-width: 560px) {
  .title {
    font-size: 34px;
  }
}

/* =========================
   Layout
   ========================= */

.layout {
  display: grid;
  grid-template-columns: 1fr 330px;
  gap: 14px;
  align-items: start;
}

@media (max-width: 1050px) {
  .layout {
    grid-template-columns: 1fr 320px;
  }
}

@media (max-width: 820px) {
  .layout {
    grid-template-columns: 1fr;
  }
}

/* =========================
   Grid
   ========================= */

.grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}

@media (max-width: 1050px) {
  .grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 560px) {
  .grid {
    grid-template-columns: 1fr;
  }
}

/* =========================
   Cards (links)
   ========================= */

.card {
  display: flex;
  align-items: center;
  text-decoration: none;
  color: var(--text);

  padding: 0 22px;
  min-height: 96px;

  border-radius: 24px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: var(--shadow);

  transition: transform 140ms ease, border-color 150ms ease,
    box-shadow 150ms ease;
}

.card-top {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  min-width: 0;
}

.card-title {
  font-size: 19px;
  font-weight: 650;
  letter-spacing: -0.015em;
  line-height: 1.1;
}

.card:hover {
  transform: translateY(-2px);
  border-color: var(--stroke-strong);
  box-shadow: 0 20px 52px rgba(0, 0, 0, 0.16);
}

.card:active {
  transform: translateY(0) scale(0.992);
}

/* =========================
   Icons
   ========================= */

.icon {
  width: 40px;
  height: 40px;
  display: grid;
  place-items: center;

  border-radius: 14px;
  border: 1px solid var(--icon-border);
  background: var(--icon-bg);

  color: var(--icon-fg);
  flex: 0 0 auto;
}

.ico {
  width: var(--icon-size);
  height: var(--icon-size);
  display: block;
}

/* Enforce thin stroke even if SVG has a heavier one inline */
.ico,
.ico * {
  vector-effect: non-scaling-stroke;
  stroke-width: var(--icon-stroke) !important;
}

/* =========================
   Panels
   ========================= */

.panel {
  border-radius: var(--radius);
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: var(--shadow);
  padding: 14px;
}

.panel + .panel {
  margin-top: 14px;
}

.panel-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.panel-title {
  font-weight: 700;
  font-size: 16px;
  letter-spacing: -0.01em;
}

.panel-sub {
  margin-top: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
}

/* =========================
   Weather
   ========================= */

.pill {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
}

.weather-main {
  margin-top: 10px;
}

.weather-big {
  display: flex;
  align-items: center;
  gap: 10px;
}

.weather-emoji {
  font-size: 22px;
}

.weather-temp {
  font-size: 34px;
  font-weight: 780;
  letter-spacing: -0.03em;
}

.weather-sub {
  margin-top: 6px;
  font-size: 13px;
  color: var(--muted);
}

.weather-mini {
  margin-top: 10px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 12px;
  color: var(--muted);
}

.weather-chip {
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
}

/* =========================
   Checklist
   ========================= */

.todo.todo-lines {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
}

.todo.todo-lines .todo-item {
  display: grid;
  grid-template-columns: 26px 1fr;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: transparent;
  border-bottom: 1px solid
    color-mix(in srgb, var(--stroke) 70%, transparent 30%);
}

.todo.todo-lines .todo-item:last-child {
  border-bottom: none;
}

.todo.todo-lines .todo-item input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1.5px solid var(--stroke-strong);
  background: color-mix(in srgb, var(--card2) 85%, transparent 15%);
  display: grid;
  place-items: center;
  cursor: pointer;
  transition: transform 80ms ease, background 150ms ease,
    border-color 150ms ease;
}

.todo.todo-lines .todo-item input[type="checkbox"]:active {
  transform: scale(0.96);
}

.todo.todo-lines .todo-item input[type="checkbox"]::after {
  content: "‚úì";
  font-size: 12px;
  font-weight: 900;
  transform: translateY(-0.5px);
  color: white;
  opacity: 0;
}

.todo.todo-lines .todo-item input[type="checkbox"]:checked {
  background: #34c759;
  border-color: rgba(0, 0, 0, 0.08);
}

.todo.todo-lines .todo-item input[type="checkbox"]:checked::after {
  opacity: 1;
}

.todo.todo-lines .todo-text input {
  width: 100%;
  padding: 4px 0;
  border: none;
  background: transparent;
  color: var(--text);
  outline: none;
  font-size: 14px;
}

.todo.todo-lines .done input[type="text"] {
  text-decoration: line-through;
  opacity: 0.62;
}

/* =========================
   Buttons
   ========================= */

.ghostbtn {
  appearance: none;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
  cursor: pointer;
  color: var(--text);
}

.ghostbtn:hover {
  border-color: var(--stroke-strong);
}

.panel-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* =========================
   Modal
   ========================= */

.modal {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 999;
}

.modal[aria-hidden="false"] {
  display: block;
}

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.34);
  backdrop-filter: blur(10px);
}

.modal-card {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: min(520px, calc(100vw - 36px));
  border-radius: 22px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
  padding: 14px;
}

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.modal-title {
  font-weight: 750;
  font-size: 16px;
}

.modal-sub {
  margin-top: 6px;
  color: var(--muted);
  font-size: 12px;
}

.archive-list {
  margin-top: 12px;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
}

.archive-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-bottom: 1px solid
    color-mix(in srgb, var(--stroke) 70%, transparent 30%);
}

.archive-row:last-child {
  border-bottom: none;
}

.archive-text {
  color: color-mix(in srgb, var(--text) 92%, transparent 8%);
  font-size: 14px;
  text-decoration: line-through;
  opacity: 0.75;
}

.archive-btn {
  appearance: none;
  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text);
}

.archive-btn:hover {
  border-color: var(--stroke-strong);
}

/* =========================
   Version badge
   ========================= */

.version {
  position: fixed;
  bottom: 14px;
  right: 16px;
  font-size: 12px;
  color: var(--muted);
  opacity: 0.7;
  letter-spacing: 0.02em;
  user-select: none;
  pointer-events: none;
}
/* =========================
   Link button styles
   ========================= */

.back-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;

  padding: 8px 12px;
  border-radius: 999px;

  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
  color: var(--text);

  text-decoration: none;
  font-size: 12px;
  font-weight: 650;
  letter-spacing: 0.02em;

  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
  transition: transform 140ms ease, border-color 150ms ease,
    box-shadow 150ms ease, background 150ms ease;
}

/* smaller utility version for header */
.back-link--small {
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 650;
  opacity: 0.92;
}

.back-link:hover {
  transform: translateY(-1px);
  border-color: var(--stroke-strong);
  background: var(--surface);
  box-shadow: 0 14px 34px rgba(0, 0, 0, 0.12);
}

.back-link:active {
  transform: translateY(0) scale(0.99);
}

.back-link:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px
      color-mix(in srgb, var(--stroke-strong) 55%, transparent 45%),
    0 14px 34px rgba(0, 0, 0, 0.12);
}

/* Settings icon button (header) */
.iconbtn {
  width: 38px;
  height: 38px;
  display: grid;
  place-items: center;
  border-radius: 999px;

  border: 1px solid var(--stroke);
  background: var(--surface-quiet);
  color: var(--text);

  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
  transition: transform 140ms ease, border-color 150ms ease,
    box-shadow 150ms ease, background 150ms ease;
}

.iconbtn:hover {
  transform: translateY(-1px);
  border-color: var(--stroke-strong);
  background: var(--surface);
  box-shadow: 0 14px 34px rgba(0, 0, 0, 0.12);
}

.iconbtn:active {
  transform: translateY(0) scale(0.99);
}

.iconbtn:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px
      color-mix(in srgb, var(--stroke-strong) 55%, transparent 45%),
    0 14px 34px rgba(0, 0, 0, 0.12);
}

.iconbtn .ico {
  width: 18px;
  height: 18px;
}
// icons.js
window.ICONS = [
  { id: "link", label: "Link", path: `<path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"></path><path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"></path>` },
  { id: "cap", label: "School", path: `<path d="M22 10L12 4 2 10l10 6 10-6z"></path><path d="M6 12v5c0 1 3 3 6 3s6-2 6-3v-5"></path>` },
  { id: "book", label: "Book", path: `<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V5A2 2 0 0 1 6 3h14v19z"></path>` },
  { id: "folder", label: "Folder", path: `<path d="M3 7h6l2 2h10v10a2 2 0 0 1-2 2H3z"></path><path d="M3 7v12"></path>` },
  { id: "mail", label: "Mail", path: `<path d="M4 4h16v16H4z"></path><path d="M22 6l-10 7L2 6"></path>` },
  { id: "home", label: "Home", path: `<path d="M3 10.5L12 3l9 7.5"></path><path d="M5 10v11h14V10"></path>` },
  { id: "play", label: "Play", path: `<path d="M8 5l12 7-12 7z"></path>` },
  { id: "camera", label: "Camera", path: `<path d="M4 7h4l2-2h4l2 2h4v14H4z"></path><circle cx="12" cy="14" r="3.5"></circle>` },
  { id: "tv", label: "TV", path: `<rect x="3" y="7" width="18" height="12" rx="2"></rect><path d="M8 21h8"></path>` },
  { id: "spark", label: "Spark", path: `<path d="M12 2l1.2 4.2L17 7.5l-3.8 1.3L12 13l-1.2-4.2L7 7.5l3.8-1.3z"></path><path d="M5 14l.8 2.6L8 17.5l-2.2.8L5 21l-.8-2.7L2 17.5l2.2-.9z"></path>` },
  { id: "gear", label: "Settings", path: `<path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M19.4 15a7.9 7.9 0 0 0 .1-1 7.9 7.9 0 0 0-.1-1l2-1.5-2-3.4-2.3.6a7.6 7.6 0 0 0-1.7-1L15 3h-6l-.4 2.7a7.6 7.6 0 0 0-1.7 1L4.6 6.1 2.6 9.5l2 1.5a7.9 7.9 0 0 0-.1 1 7.9 7.9 0 0 0 .1 1l-2 1.5 2 3.4 2.3-.6a7.6 7.6 0 0 0 1.7 1L9 21h6l.4-2.7a7.6 7.6 0 0 0 1.7-1l2.3.6 2-3.4-2-1.5z"></path>` },
  { id: "music", label: "Music", path: `<path d="M9 18a3 3 0 1 0 0-6"></path><path d="M9 12V5l12-2v7"></path><path d="M21 16a3 3 0 1 0 0-6"></path>` },
  { id: "chat", label: "Chat", path: `<path d="M21 14a4 4 0 0 1-4 4H8l-5 3V6a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>` },
  { id: "calendar", label: "Calendar", path: `<path d="M7 3v3"></path><path d="M17 3v3"></path><path d="M4 8h16"></path><rect x="4" y="5" width="16" height="16" rx="2"></rect>` },
  { id: "clock", label: "Clock", path: `<circle cx="12" cy="12" r="9"></circle><path d="M12 7v6l4 2"></path>` },
  { id: "star", label: "Star", path: `<path d="M12 2l3 7 7 .5-5.5 4.5 2 7-6.5-4-6.5 4 2-7L2 9.5 9 9z"></path>` },
  { id: "heart", label: "Heart", path: `<path d="M20.5 9.5c0 6-8.5 11-8.5 11S3.5 15.5 3.5 9.5A4.5 4.5 0 0 1 12 7a4.5 4.5 0 0 1 8.5 2.5z"></path>` },
  { id: "map", label: "Map", path: `<path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"></path><path d="M9 3v15"></path><path d="M15 6v15"></path>` },
  { id: "pin", label: "Pin", path: `<path d="M12 21s7-4.4 7-11a7 7 0 1 0-14 0c0 6.6 7 11 7 11z"></path><circle cx="12" cy="10" r="2.5"></circle>` },
  { id: "doc", label: "Doc", path: `<path d="M7 3h7l3 3v15H7z"></path><path d="M14 3v3h3"></path><path d="M9 12h6"></path><path d="M9 16h6"></path>` },
  { id: "download", label: "Download", path: `<path d="M12 3v10"></path><path d="M8 10l4 4 4-4"></path><path d="M5 21h14"></path>` },
  { id: "upload", label: "Upload", path: `<path d="M12 21V11"></path><path d="M8 14l4-4 4 4"></path><path d="M5 3h14"></path>` },
  { id: "bolt", label: "Bolt", path: `<path d="M13 2L3 14h7l-1 8 10-12h-7z"></path>` },
  { id: "shield", label: "Shield", path: `<path d="M12 2l8 4v6c0 6-4 10-8 10S4 18 4 12V6z"></path>` },
  { id: "globe", label: "Globe", path: `<circle cx="12" cy="12" r="9"></circle><path d="M3 12h18"></path><path d="M12 3a14 14 0 0 1 0 18"></path><path d="M12 3a14 14 0 0 0 0 18"></path>` },
  { id: "code", label: "Code", path: `<path d="M9 18l-6-6 6-6"></path><path d="M15 6l6 6-6 6"></path>` },
];// Home page script
// - Subtitle clock (minute-synced)
// - Search bar auto-focus + same-tab navigation
// - Weather (Open-Meteo) + custom city via Settings
// - Links grid rendered from localStorage (editable via Settings)
// - Checklist with archive modal
// - Service worker registration

const STORE_KEY = "home.state.v1";      // checklist state
const LINKS_KEY = "home.links.v1";      // links grid
const WEATHER_KEY = "home.weather.v1";  // custom city (lat/lon/tz/name)

// ---------- Small utils ----------
const $ = (sel) => document.querySelector(sel);

function uuid() {
  return (
    crypto?.randomUUID?.() ||
    `id-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`
  );
}

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}

function saveJSON(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch {}
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

function focusInputByTaskId(id) {
  const inp = document.querySelector(`input[data-task-id="${id}"]`);
  if (!inp) return;
  inp.focus({ preventScroll: true });
  const v = inp.value || "";
  try {
    inp.setSelectionRange(v.length, v.length);
  } catch {}
}

// ---------- Subtitle clock ----------
function setSubtitle() {
  const el = $("#subtitle");
  if (!el) return;

  const prefs = getWeatherPrefs(); // uses WEATHER_KEY + defaultWeatherPrefs()
  const tz = prefs?.tz || "America/New_York";

  el.textContent = new Date().toLocaleString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
    timeZone: tz,
    timeZoneName: "short",
  });
}

function startSubtitleClock() {
  setSubtitle();
  const now = new Date();
  const msUntilNextMinute =
    (60 - now.getSeconds()) * 1000 - now.getMilliseconds();

  setTimeout(() => {
    setSubtitle();
    setInterval(setSubtitle, 60 * 1000);
  }, msUntilNextMinute);
}

// ---------- Search ----------
function isLikelyUrl(text) {
  const s = text.trim();
  if (/^https?:\/\//i.test(s)) return true;
  return !/\s/.test(s) && /\.[a-z]{2,}([/:?#]|$)/i.test(s);
}

function normalizeUrl(text) {
  const s = text.trim();
  return /^https?:\/\//i.test(s) ? s : `https://${s}`;
}

function googleSearchUrl(q) {
  return `https://www.google.com/search?q=${encodeURIComponent(q.trim())}`;
}

function initSearch() {
  const form = $("#searchForm");
  const input = $("#searchInput");
  if (!form || !input) return;

  const focusSearch = () => {
    input.focus({ preventScroll: true });
    const v = input.value || "";
    try {
      input.setSelectionRange(v.length, v.length);
    } catch {}
  };

  requestAnimationFrame(focusSearch);
  window.addEventListener("load", focusSearch, { once: true });

  // "/" focuses search unless typing in another field
  window.addEventListener("keydown", (e) => {
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const typing = tag === "input" || tag === "textarea";
    if (e.key === "/" && !typing) {
      e.preventDefault();
      focusSearch();
    }
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = (input.value || "").trim();
    if (!text) return;

    window.location.href = isLikelyUrl(text)
      ? normalizeUrl(text)
      : googleSearchUrl(text);
  });
}

// ---------- Links Grid ----------
function defaultLinks() {
  // Used only if no links exist yet.
  return [
    {
    id: uuid(),
    title: "Netflix",
    url: "https://www.netflix.com",
    icon: "tv",
  },
  {
    id: uuid(),
    title: "Google Drive",
    url: "https://drive.google.com",
    icon: "folder",
  },
  {
    id: uuid(),
    title: "Instagram",
    url: "https://www.instagram.com",
    icon: "camera",
  },
  {
    id: uuid(),
    title: "HBO Max",
    url: "https://www.max.com",
    icon: "play",
  },
  {
    id: uuid(),
    title: "Outlook",
    url: "https://outlook.live.com",
    icon: "mail",
  },
  {
    id: uuid(),
    title: "Zillow",
    url: "https://www.zillow.com",
    icon: "home",
  },
  ];
}

function getLinks() {
  const links = loadJSON(LINKS_KEY, null);
  if (Array.isArray(links) && links.length) return links;

  const seeded = defaultLinks();
  saveJSON(LINKS_KEY, seeded);
  return seeded;
}

function iconSvg(kind) {
  const list = window.ICONS || [];
  const icon = list.find((i) => i.id === kind) || list.find((i) => i.id === "link");
  const path = icon?.path || "";
  return `
    <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      ${path}
    </svg>
  `;
}

function renderLinksGrid() {
  const root = document.getElementById("linksGrid");
  if (!root) return;

  const links = getLinks();
  root.innerHTML = "";

  if (!links.length) {
    root.innerHTML = `<a class="card" href="./settings.html">
      <div class="card-top">
        <span class="icon" aria-hidden="true">${iconSvg("link")}</span>
        <div class="card-title">Add links in Settings</div>
      </div>
    </a>`;
    return;
  }

  links.forEach((l) => {
    const title = (l.title || "").trim() || "Untitled";
    let url = (l.url || "").trim();

    // If it's blank, send them to Settings so it doesn't feel dead.
    if (!url) url = "./settings.html";

    // If user omitted scheme but it looks like a domain, fix it.
    if (url !== "./settings.html" && !/^https?:\/\//i.test(url) && url.includes(".")) {
      url = "https://" + url;
    }

    const a = document.createElement("a");
    a.className = "card";
    a.href = url;

    a.innerHTML = `
      <div class="card-top">
        <span class="icon" aria-hidden="true">${iconSvg(l.icon || "link")}</span>
        <div class="card-title">${escapeHtml(title)}</div>
      </div>
    `;

    root.appendChild(a);
  });
}

// ---------- Checklist State ----------
function defaultState() {
  const now = Date.now();
  return {
    active: [
      { id: uuid(), text: "Do laundry", created: now, checked: false, pendingArchiveAt: null },
      { id: uuid(), text: "Go grocery shopping", created: now, checked: false, pendingArchiveAt: null },
      { id: uuid(), text: "Buy valentines gift", created: now, checked: false, pendingArchiveAt: null },
      { id: uuid(), text: "Walk dog", created: now, checked: false, pendingArchiveAt: null },
    ],
    archived: [],
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return {
      active: Array.isArray(parsed.active) ? parsed.active : defaultState().active,
      archived: Array.isArray(parsed.archived) ? parsed.archived : [],
    };
  } catch {
    return defaultState();
  }
}

function saveState(state) {
  try {
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  } catch {}
}

// ---------- Checklist render ----------
function renderActive(state) {
  const root = $("#todo");
  if (!root) return;
  root.innerHTML = "";

  state.active.forEach((t, idx) => {
    const row = document.createElement("div");
    row.className = "todo-item" + (t.checked ? " done" : "");

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!t.checked;

    cb.addEventListener("change", () => {
      t.checked = cb.checked;
      t.pendingArchiveAt = t.checked ? Date.now() + 5000 : null;
      saveState(state);
      renderActive(state);
      renderArchive(state);
    });

    const textWrap = document.createElement("div");
    textWrap.className = "todo-text";

    const input = document.createElement("input");
    input.type = "text";
    input.value = t.text ?? "";
    input.placeholder = "New task‚Ä¶";
    input.setAttribute("data-task-id", t.id);

    input.addEventListener("input", () => {
      t.text = input.value;
      saveState(state);
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const newTask = { id: uuid(), text: "", created: Date.now(), checked: false, pendingArchiveAt: null };
        state.active.splice(idx + 1, 0, newTask);
        saveState(state);
        renderActive(state);
        requestAnimationFrame(() => focusInputByTaskId(newTask.id));
        return;
      }

      if (e.key === "Backspace" && (input.value || "").length === 0) {
        if (state.active.length === 1) return;
        e.preventDefault();
        state.active.splice(idx, 1);
        saveState(state);
        renderActive(state);
        const target = state.active[Math.max(0, idx - 1)] || state.active[0];
        requestAnimationFrame(() => focusInputByTaskId(target.id));
        return;
      }

      if (e.key === "ArrowUp") {
        const prev = state.active[idx - 1];
        if (prev) {
          e.preventDefault();
          focusInputByTaskId(prev.id);
        }
      }

      if (e.key === "ArrowDown") {
        const next = state.active[idx + 1];
        if (next) {
          e.preventDefault();
          focusInputByTaskId(next.id);
        }
      }
    });

    textWrap.appendChild(input);
    row.appendChild(cb);
    row.appendChild(textWrap);
    root.appendChild(row);
  });
}

function renderArchive(state) {
  const list = $("#archiveList");
  if (!list) return;

  if (!state.archived.length) {
    list.innerHTML = `<div class="archive-row">
      <div class="archive-text" style="text-decoration:none;opacity:.55;">No completed tasks yet.</div>
    </div>`;
    return;
  }

  list.innerHTML = "";
  state.archived
    .slice()
    .sort((a, b) => (b.archivedAt || 0) - (a.archivedAt || 0))
    .forEach((t) => {
      const row = document.createElement("div");
      row.className = "archive-row";

      const text = document.createElement("div");
      text.className = "archive-text";
      text.textContent = t.text || "(empty)";

      const restore = document.createElement("button");
      restore.className = "archive-btn";
      restore.type = "button";
      restore.textContent = "Restore";
      restore.addEventListener("click", () => {
        state.archived = state.archived.filter((x) => x.id !== t.id);
        state.active.unshift({
          id: t.id,
          text: t.text,
          created: t.created || Date.now(),
          checked: false,
          pendingArchiveAt: null,
        });
        saveState(state);
        renderArchive(state);
        renderActive(state);
        requestAnimationFrame(() => focusInputByTaskId(t.id));
      });

      const del = document.createElement("button");
      del.className = "archive-btn";
      del.type = "button";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        state.archived = state.archived.filter((x) => x.id !== t.id);
        saveState(state);
        renderArchive(state);
      });

      row.appendChild(text);
      row.appendChild(restore);
      row.appendChild(del);
      list.appendChild(row);
    });
}

function tickArchive(state) {
  const now = Date.now();
  let moved = false;

  const remaining = [];
  for (const t of state.active) {
    if (t.checked && t.pendingArchiveAt && now >= t.pendingArchiveAt) {
      state.archived.push({ id: t.id, text: t.text, created: t.created, archivedAt: now });
      moved = true;
    } else {
      remaining.push(t);
    }
  }

  if (moved) {
    state.active =
      remaining.length
        ? remaining
        : [{ id: uuid(), text: "", created: Date.now(), checked: false, pendingArchiveAt: null }];

    saveState(state);
    renderActive(state);
    renderArchive(state);
  }
}

// ---------- Modal ----------
function openArchive() {
  $("#archiveModal")?.setAttribute("aria-hidden", "false");
}
function closeArchive() {
  $("#archiveModal")?.setAttribute("aria-hidden", "true");
}

// ---------- Weather ----------
function defaultWeatherPrefs() {
  // DEFAULT: Seattle
  return {
    name: "Seattle, WA, United States",
    lat: 47.6062,
    lon: -122.3321,
    tz: "America/Los_Angeles",
  };
}

function getWeatherPrefs() {
  const prefs = loadJSON(WEATHER_KEY, null);
  if (
    prefs &&
    typeof prefs === "object" &&
    typeof prefs.lat === "number" &&
    typeof prefs.lon === "number"
  ) {
    return {
      name: prefs.name || defaultWeatherPrefs().name,
      lat: prefs.lat,
      lon: prefs.lon,
      tz: prefs.tz || defaultWeatherPrefs().tz,
    };
  }
  return defaultWeatherPrefs();
}

function wxFromCode(code) {
  if (code === 0) return { e: "‚òÄÔ∏è", d: "Clear" };
  if (code === 1 || code === 2) return { e: "üå§Ô∏è", d: "Partly cloudy" };
  if (code === 3) return { e: "‚òÅÔ∏è", d: "Cloudy" };
  if (code === 45 || code === 48) return { e: "üå´Ô∏è", d: "Fog" };
  if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return { e: "üåßÔ∏è", d: "Rain" };
  if ([71, 73, 75, 77, 85, 86].includes(code)) return { e: "üå®Ô∏è", d: "Snow" };
  if ([95, 96, 99].includes(code)) return { e: "‚õàÔ∏è", d: "Thunderstorms" };
  return { e: "‚õÖÔ∏è", d: "Weather" };
}

async function loadWeather() {
  const prefs = getWeatherPrefs();
  const lat = prefs.lat;
  const lon = prefs.lon;

  const cityPill = $("#weatherCity");
  if (cityPill) {
  const label = (prefs.name || "Weather").split(",")[0].trim();
  cityPill.textContent = label || "Weather";
}

  const url =
    "https://api.open-meteo.com/v1/forecast" +
    `?latitude=${lat}&longitude=${lon}` +
    `&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m` +
    `&daily=temperature_2m_max,temperature_2m_min` +
    `&temperature_unit=fahrenheit&wind_speed_unit=mph` +
    `&timezone=${encodeURIComponent(prefs.tz || "America/Los_Angeles")}`;

  const tempEl = $("#wxTemp");
  const descEl = $("#wxDesc");
  const emojiEl = $("#wxEmoji");
  const miniEl = $("#wxMini");

  try {
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();

    const cur = data.current;
    const daily = data.daily;

    const t = Math.round(cur.temperature_2m);
    const feels = Math.round(cur.apparent_temperature);
    const wind = Math.round(cur.wind_speed_10m);
    const wx = wxFromCode(cur.weather_code);

    const hi = Math.round(daily.temperature_2m_max?.[0]);
    const lo = Math.round(daily.temperature_2m_min?.[0]);

    if (tempEl) tempEl.textContent = `${t}¬∞`;
    if (emojiEl) emojiEl.textContent = wx.e;
    if (descEl) descEl.textContent = `${wx.d} ‚Ä¢ Feels like ${feels}¬∞`;

    if (miniEl) {
      miniEl.innerHTML = `
        <span class="weather-chip">H: ${hi}¬∞</span>
        <span class="weather-chip">L: ${lo}¬∞</span>
        <span class="weather-chip">Wind: ${wind} mph</span>
      `;
    }
  } catch {
    if (descEl) descEl.textContent = "Weather unavailable";
  }
}

// ---------- Init ----------
(function init() {
  window.renderVersionBadge?.();

  startSubtitleClock();
  initSearch();

  // links grid
  renderLinksGrid();

  // checklist
  const state = loadState();
  saveState(state);

  renderActive(state);
  renderArchive(state);

  $("#archiveBtn")?.addEventListener("click", openArchive);
  $("#archiveClose")?.addEventListener("click", closeArchive);
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeArchive();
  });

  // 500ms is plenty and reduces churn vs 300ms
  setInterval(() => tickArchive(state), 500);

  // weather
  loadWeather();
  setInterval(loadWeather, 20 * 60 * 1000);
})();

// Service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(() => {});
}// settings.js

const STORE_KEY = "home.state.v1";
const LINKS_KEY = "home.links.v1";
const WEATHER_KEY = "home.weather.v1";

const $ = (sel) => document.querySelector(sel);

function uuid() {
  return (
    crypto?.randomUUID?.() ||
    `id-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`
  );
}

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}

function saveJSON(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch {}
}

function esc(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

function normalizeUrl(url) {
  const s = (url || "").trim();
  if (!s) return "";
  if (/^https?:\/\//i.test(s)) return s;
  if (s.startsWith("./") || s.startsWith("/")) return s;
  if (s.includes(".")) return "https://" + s;
  return s;
}

function iconSVG(iconId) {
  const icon = ICONS.find((i) => i.id === iconId) || ICONS[0];
  return `
    <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      ${icon.path}
    </svg>
  `;
}

// ----- Weather -----
function defaultWeatherPrefs() {
  return {
    name: "Seattle, WA, United States",
    lat: 47.6062,
    lon: -122.3321,
    tz: "America/Los_Angeles",
  };
}

function getWeatherPrefs() {
  const prefs = loadJSON(WEATHER_KEY, null);
  if (prefs && typeof prefs.lat === "number" && typeof prefs.lon === "number") {
    return {
      name: prefs.name || defaultWeatherPrefs().name,
      lat: prefs.lat,
      lon: prefs.lon,
      tz: prefs.tz || defaultWeatherPrefs().tz,
    };
  }
  return defaultWeatherPrefs();
}

function setCityPill() {
  const pill = $("#currentCityPill");
  if (!pill) return;
  const prefs = getWeatherPrefs();
  const label = (prefs.name || "Weather").split(",")[0].trim();
  pill.textContent = label || "Weather";
}

async function searchCities(q) {
  const url =
    "https://geocoding-api.open-meteo.com/v1/search" +
    `?name=${encodeURIComponent(q)}` +
    `&count=8&language=en&format=json`;

  const res = await fetch(url, { cache: "no-store" });
  const data = await res.json();
  return Array.isArray(data.results) ? data.results : [];
}

function renderCityResults(results) {
  const root = $("#cityResults");
  if (!root) return;

  if (!results.length) {
    root.innerHTML = `<div class="panel-sub">No results.</div>`;
    return;
  }

  root.innerHTML = results
    .map((r) => {
      const full =
        [r.name, r.admin1, r.country].filter(Boolean).join(", ") || "Unknown";
      const shown = (full || "Weather").split(",")[0].trim();

      return `
        <button class="ghostbtn" type="button" data-city='${esc(
          JSON.stringify({
            name: full,
            lat: r.latitude,
            lon: r.longitude,
            tz: r.timezone,
          })
        )}' style="width:100%; text-align:left; display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:10px;">
          <span style="font-weight:650;">${esc(shown)}</span>
          <span style="font-size:12px; color:var(--muted);">${esc(
            [r.admin1, r.country].filter(Boolean).join(", ")
          )}</span>
        </button>
      `;
    })
    .join("");

  root.querySelectorAll("button[data-city]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const data = JSON.parse(btn.getAttribute("data-city"));
      saveJSON(WEATHER_KEY, data);
      setCityPill();
      root.innerHTML = `<div class="panel-sub">Saved.</div>`;
    });
  });
}

// ----- Links -----
function getLinks() {
  const links = loadJSON(LINKS_KEY, []);
  return Array.isArray(links) ? links : [];
}
function setLinks(links) {
  saveJSON(LINKS_KEY, links);
}

function renderLinksList() {
  const root = $("#linksList");
  if (!root) return;

  const links = getLinks();

  if (!links.length) {
    root.innerHTML = `<div class="panel-sub">No links yet. Click ‚ÄúAdd link‚Äù.</div>`;
    return;
  }

  root.innerHTML = links
    .map((l, idx) => {
      const title = (l.title || "").trim() || "Untitled";
      const url = (l.url || "").trim() || "";
      const icon = l.icon || "link";
      return `
        <div class="archive-row" style="grid-template-columns: 44px 1fr auto auto auto;">
          <div class="icon" aria-hidden="true" style="width:40px;height:40px;border-radius:14px;">
            ${iconSVG(icon)}
          </div>
          <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
            <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${esc(title)}</div>
            <div style="font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${esc(url)}</div>
          </div>
          <button class="archive-btn" type="button" data-act="up" data-idx="${idx}">‚Üë</button>
          <button class="archive-btn" type="button" data-act="down" data-idx="${idx}">‚Üì</button>
          <button class="archive-btn" type="button" data-act="edit" data-idx="${idx}">Edit</button>
        </div>
      `;
    })
    .join("");

  root.querySelectorAll("button[data-act]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const act = btn.getAttribute("data-act");
      const idx = Number(btn.getAttribute("data-idx"));
      const links = getLinks();

      if (act === "up" && idx > 0) {
        [links[idx - 1], links[idx]] = [links[idx], links[idx - 1]];
        setLinks(links);
        renderLinksList();
      }

      if (act === "down" && idx < links.length - 1) {
        [links[idx + 1], links[idx]] = [links[idx], links[idx + 1]];
        setLinks(links);
        renderLinksList();
      }

      if (act === "edit") openLinkModal(idx);
    });
  });
}

// ----- Archive (read-only + manage) -----
function loadChecklistState() {
  const st = loadJSON(STORE_KEY, null);
  if (!st || typeof st !== "object") return { active: [], archived: [] };
  return {
    active: Array.isArray(st.active) ? st.active : [],
    archived: Array.isArray(st.archived) ? st.archived : [],
  };
}

function saveChecklistState(st) {
  saveJSON(STORE_KEY, st);
}

function renderArchive() {
  const list = $("#archiveList");
  if (!list) return;

  const st = loadChecklistState();
  const archived = st.archived || [];

  if (!archived.length) {
    list.innerHTML = `<div class="archive-row">
      <div class="archive-text" style="text-decoration:none;opacity:.55;">No completed tasks yet.</div>
    </div>`;
    return;
  }

  list.innerHTML = "";
  archived
    .slice()
    .sort((a, b) => (b.archivedAt || 0) - (a.archivedAt || 0))
    .forEach((t) => {
      const row = document.createElement("div");
      row.className = "archive-row";

      const text = document.createElement("div");
      text.className = "archive-text";
      text.textContent = t.text || "(empty)";

      const restore = document.createElement("button");
      restore.className = "archive-btn";
      restore.type = "button";
      restore.textContent = "Restore";
      restore.addEventListener("click", () => {
        const st = loadChecklistState();
        st.archived = st.archived.filter((x) => x.id !== t.id);
        st.active.unshift({
          id: t.id,
          text: t.text,
          created: t.created || Date.now(),
          checked: false,
          pendingArchiveAt: null,
        });
        saveChecklistState(st);
        renderArchive();
      });

      const del = document.createElement("button");
      del.className = "archive-btn";
      del.type = "button";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        const st = loadChecklistState();
        st.archived = st.archived.filter((x) => x.id !== t.id);
        saveChecklistState(st);
        renderArchive();
      });

      row.appendChild(text);
      row.appendChild(restore);
      row.appendChild(del);
      list.appendChild(row);
    });
}

// ----- Link Modal -----
let editingIndex = null;
let selectedIcon = "link";

function openModal() {
  const m = $("#linkModal");
  if (!m) return;
  m.setAttribute("aria-hidden", "false");

  // prevent backdrop click from instantly closing when clicking inside card
  const card = m.querySelector(".modal-card");
  if (card && !card.__wired) {
    card.__wired = true;
    card.addEventListener("click", (e) => e.stopPropagation());
  }
}

function closeModal() {
  $("#linkModal")?.setAttribute("aria-hidden", "true");
}

function renderIconPicker() {
  const root = $("#iconPicker");
  if (!root) return;

  root.innerHTML = ICONS.map((ic) => {
    const on = ic.id === selectedIcon;
    return `
      <button type="button" class="iconbtn" data-icon="${ic.id}"
        style="width:44px;height:44px;border-radius:14px;${on ? `border-color: var(--stroke-strong); background: var(--surface);` : ""}"
        title="${esc(ic.label)}">
        ${iconSVG(ic.id)}
      </button>
    `;
  }).join("");

  root.querySelectorAll("button[data-icon]").forEach((b) => {
    b.addEventListener("click", () => {
      selectedIcon = b.getAttribute("data-icon");
      renderIconPicker();
    });
  });
}

function openLinkModal(idx = null) {
  const titleEl = $("#linkModalTitle");
  const delBtn = $("#deleteLinkBtn");
  const t = $("#linkTitle");
  const u = $("#linkUrl");

  editingIndex = typeof idx === "number" ? idx : null;

  if (editingIndex === null) {
    if (titleEl) titleEl.textContent = "Add link";
    if (delBtn) delBtn.style.display = "none";
    if (t) t.value = "";
    if (u) u.value = "";
    selectedIcon = "link";
  } else {
    const links = getLinks();
    const link = links[editingIndex];
    if (titleEl) titleEl.textContent = "Edit link";
    if (delBtn) delBtn.style.display = "inline-flex";
    if (t) t.value = link?.title || "";
    if (u) u.value = link?.url || "";
    selectedIcon = link?.icon || "link";
  }

  renderIconPicker();
  openModal();

  // focus title
  requestAnimationFrame(() => {
    $("#linkTitle")?.focus?.({ preventScroll: true });
  });
}

function saveLinkFromModal() {
  const t = ($("#linkTitle")?.value || "").trim();
  const uRaw = ($("#linkUrl")?.value || "").trim();
  const u = normalizeUrl(uRaw);
  const links = getLinks();

  if (!u) {
    alert("Please enter a URL.");
    return;
  }

  const linkObj = {
    id: editingIndex === null ? uuid() : (links[editingIndex]?.id || uuid()),
    title: t || "Untitled",
    url: u,
    icon: selectedIcon || "link",
  };

  if (editingIndex === null) links.push(linkObj);
  else links[editingIndex] = linkObj;

  setLinks(links);
  renderLinksList();
  closeModal();
}

function deleteLinkFromModal() {
  if (editingIndex === null) return;
  const links = getLinks();
  links.splice(editingIndex, 1);
  setLinks(links);
  renderLinksList();
  closeModal();
}

// ----- Init -----
(function init() {
  window.renderVersionBadge?.();
  setCityPill();
  renderLinksList();
  renderArchive();


  // weather search
  $("#cityForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const q = ($("#cityInput")?.value || "").trim();
    if (!q) return;
    $("#cityResults").innerHTML = `<div class="panel-sub">Searching‚Ä¶</div>`;
    try {
      const results = await searchCities(q);
      renderCityResults(results);
    } catch {
      $("#cityResults").innerHTML = `<div class="panel-sub">Search failed.</div>`;
    }
  });

  // link modal wiring
  $("#addLinkBtn")?.addEventListener("click", () => openLinkModal(null));

  // clicking backdrop closes (but modal-card stops propagation)
  $("#linkModalClose")?.addEventListener("click", closeModal);

  // "Done" should not silently discard edits: if URL field has something, save; else close
  $("#linkModalDone")?.addEventListener("click", () => {
    const url = ($("#linkUrl")?.value || "").trim();
    const title = ($("#linkTitle")?.value || "").trim();
    // If user typed anything, save; otherwise just close
    if (url || title) saveLinkFromModal();
    else closeModal();
  });

  $("#saveLinkBtn")?.addEventListener("click", saveLinkFromModal);
  $("#deleteLinkBtn")?.addEventListener("click", deleteLinkFromModal);

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
    // Enter inside modal saves if focused on URL/title field
    if (e.key === "Enter") {
      const active = document.activeElement;
      if (active && (active.id === "linkTitle" || active.id === "linkUrl")) {
        e.preventDefault();
        saveLinkFromModal();
      }
    }
  });
})();const CACHE = "home-3.0.0";

const CORE = [
  "./",
  "./index.html",
  "./style.css",
  "./script.js",
  "./sw.js",
  "./settings.html",
  "./settings.js",
  "./version.js",
  "./icons.js",
  "./assets/fonts/Inter-roman.ttf",
  "./assets/fonts/Inter-italic.ttf", // delete this line if you didn't keep italic
];

// Install: pre-cache core, then activate immediately
self.addEventListener("install", (e) => {
  e.waitUntil((async () => {
    const c = await caches.open(CACHE);
    await c.addAll(CORE);
    await self.skipWaiting();
  })());
});

// Activate: clean old caches
self.addEventListener("activate", (e) => {
  e.waitUntil((async () => {
    const keys = await caches.keys();
    await Promise.all(keys.filter((k) => k !== CACHE).map((k) => caches.delete(k)));
    await self.clients.claim();
  })());
});

// Fetch: stale-while-revalidate for same-origin GET requests.
// Cross-origin (like open-meteo) goes straight to network.
self.addEventListener("fetch", (e) => {
  const req = e.request;
  if (req.method !== "GET") return;

  const url = new URL(req.url);

  if (url.origin !== self.location.origin) return;

  e.respondWith((async () => {
    const cache = await caches.open(CACHE);
    const cached = await cache.match(req);

    const fetchPromise = fetch(req).then((res) => {
      // Only cache successful, basic responses
      if (res && res.status === 200 && res.type === "basic") {
        cache.put(req, res.clone());
      }
      return res;
    }).catch(() => cached);

    // Return cached immediately if present, update in background
    return cached || fetchPromise;
  })());
});// version.js
// Single source of truth for app version + tiny helper to render it.

window.APP_VERSION = "3.0.0";

window.renderVersionBadge = function renderVersionBadge() {
  const el = document.getElementById("version");
  if (!el) return;

  // allow hiding on specific pages if needed later
  const v = window.APP_VERSION || "dev";
  el.textContent = `v${v}`;
};